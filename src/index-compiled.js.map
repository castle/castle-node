{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["'use strict';\n\nimport restify from 'restify';\nimport packageJSON from '../package.json'\nimport ExpressWrapper from'./express-compiled.js';\nimport OS from 'os';\nimport Events from './events-compiled.js';\n\nclass Castle {\n\n    /**\n     *\n     * @param apiKey\n     * @param apiSecret\n     */\n    constructor({apiKey = null, apiSecret, apiUrl = 'https://api.castle.io', disableClientUserAgent = false}) {\n        this.apiKey                 = apiKey;\n        this.apiSecret              = apiSecret;\n        this.disableClientUserAgent = disableClientUserAgent;\n        this.apiUrl                 = apiUrl;\n        this.client                 = restify.createJsonClient({url : apiUrl});\n        this.getClient().basicAuth('test', apiSecret);\n    }\n\n    /**\n     *\n     * @param {string} event the event you want to track. This can be custom or one from Castle.Events\n     * @param {string} user_id the id of the affected user (If known)\n     * @param {object} details [optional] other details for the event. EX: the $login parameter for emails\n     * @param {object} headers [optional] the HTTP headers sent by the user/client\n     * @param {string} ip [optional] the user/client's IP Address\n     * @param {string} cookie [optional] the castle cookie left by the clientside javascript sdk\n     * @returns {Promise}\n     */\n    trackEvent({event, user_id, details = undefined, headers = {}, ip = undefined, cookie = '', userAgent = ''}) {\n        return new Promise((resolve, reject) => {\n            if (event === undefined || event === null || event === \"\") {\n                return reject(new Error('Missing event', 'MISSING_EVENT_NAME'));\n            }\n\n            var postData = {\n                name    : event,\n                user_id : user_id,\n                details : details\n            };\n            this.getClient().post({\n                path    : '/v1/events',\n                headers : this.generateHeaders(headers, ip, cookie, userAgent)\n            }, postData, (error, request, response, obj) => {\n                if (error) {\n                    return reject(error);\n                } else if (request.statusCode < 200 || request.statusCode >= 300) {\n                    return reject(new Error(`Invalid HTTP Status Code ${request.statusCode}`, 'INVALID_HTTP_STATUS_CODE'))\n                }\n                return resolve(obj);\n            });\n        });\n    }\n\n    identify({user_id, user_data, headers = {}, ip = undefined, cookie = '', userAgent = ''}) {\n        return new Promise((resolve, reject) => {\n            this.getClient().put({\n                path    : `/v1/users/${user_id}`,\n                headers : this.generateHeaders(headers, ip, cookie, userAgent)\n            }, user_data, (error, request, response, obj) => {\n                if (error) {\n                    return reject(error);\n                } else if (request.statusCode < 200 || request.statusCode >= 300) {\n                    return reject(new Error(`Invalid HTTP Status Code ${request.statusCode}`, 'INVALID_HTTP_STATUS_CODE'))\n                }\n                return resolve(obj);\n            });\n        });\n    }\n\n    generateHeaders(clientHeaders, ip, cookie, userAgent) {\n        return this.stripUndefinedVariables({\n            'X-Castle-Ip'                : ip,\n            'X-Castle-Cookie-Id'         : cookie,\n            'X-Castle-User-Agent'        : userAgent,\n            'X-Castle-Headers'           : JSON.stringify(clientHeaders),\n            'X-Castle-Client-User-Agent' : this.isClientUserAgentDisabled() ? undefined : JSON.stringify(this.getClientUserAgent())\n        });\n    }\n\n    stripUndefinedVariables(obj) {\n        var toReturn = {};\n        Object.keys(obj).forEach(k => {\n            var v = obj[k];\n            if (v !== undefined && v !== null) {\n                toReturn[k] = v;\n            }\n        });\n        return toReturn;\n    }\n\n    static express(opts) {\n        var castle = new Castle(opts);\n        return ExpressWrapper(castle);\n    }\n\n    getClient() {\n        return this.client;\n    }\n\n    /**\n     *\n     * @returns {{}}\n     */\n    getClientUserAgent() {\n        return {\n            bindings_version : packageJSON.version,\n            lang             : 'Node.js',\n            lang_version     : process.version,\n            platform         : OS.platform(),\n            publisher        : 'castle'\n        }\n    }\n\n    isClientUserAgentDisabled() {\n        return this.disableClientUserAgent || false;\n    }\n\n}\n\nCastle.Events = Events;\n\nmodule.exports = Castle;\n"]}